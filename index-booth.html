<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <title>Video Booth</title>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="../css/main.css">
    <link rel="stylesheet" href="../css/fonts/Aller/stylesheet.css">
    <!-- JS -->
    <script src="../js/vendor/jquery/dist/jquery.min.js"></script>
    <script src="../js/vendor/recordrtc/RecordRTC.js"></script>
    <script src="../js/vendor/jquery-circle-progress/dist/circle-progress.js"></script>
    <script src="../js/vendor/gsap/src/minified/TweenMax.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

  </head>
  <body>
    <div id="intake_screen" class="screen">

      <video id="intake_video" autoplay="" loop="" muted=""></video>

      <div id="feed-overlay" class="overlay centered">

        <img id="face" src="../img/face-outline.png" class="centered"/>

        <div id="record-video" class="button">
          <h1 id="count" class="centered"></h1>
          <div id="circle" class="centered"></div>
          <img id="redbtn" src="../img/record-red.png" class="centered"/>
        </div>
      </div>

      <div id="enter-name" class="popup" style="display:none">
        <div class="popup-content">
          <h3>Enter name</h3>
          <div>
            <input id="nameinput" size="16" type="text" placeholder="Your name here">
            <div id="btn_submitname" class="button"><h2>SUBMIT</h2></div>
          </div>
        </div>
      </div>

    </div>

    <div class="dev-panel" style="">
      <label for='camSource_booth'>Booth video source: </label><select id='camSource_booth'></select>
    </div>

    <script type="text/javascript">

      /* Set up Socket.IO */
      var address = '//localhost:7770';
      var socket = io.connect(address);

      socket.on('handshake', function(data) {
          socket.emit('handshake-response', {clientId: 'booth'});
      });

      function sendVisitor(visitorName, visitorVideoURL) {
        socket.emit('play-visitor-video', {nameString: visitorName, videoURL: visitorVideoURL });
        var d = currentPlaybackDelay();
      }

      socket.on('report-playback-schedule', function(data) {

        getReadyCountdown(data.startDelay);
        clearVisitorAfterDelay(data.videoURL, data.finishDelay);

      });

      socket.on('error', function() { console.error(arguments) });
      socket.on('message', function() { console.log(arguments) });

      /* ------------ */
      /* Record Video */
      /* ------------ */

      var recordVideo = $('#record-video')[0];
      var countdown = $('#count')[0];
      var video = $('#intake_video')[0];
      var camSelector = $('#camSource_booth')[0];

      var cameraStream;
      var recorder;
      var countdownCount;
      var countdownTimer;
      var captureLength = 5;
      var captureWidth = 1280;
      var captureHeight = 1024;
      var captureOptions = {
                                type: 'video',
                                video: video,
                                canvas: {
                                    width: captureWidth,
                                    height: captureHeight
                                }
                            };

      var visitorQueue = [];
      var currentRecordingURL = '';
      var delayPerVisitor = captureLength*2; //Assume half-speed playback.
      var delayIfFirst = 10; //Extra time given if none in queue.

      $("#record-video").click( function(){

          //TODO: Disable record button to avoid double click

          startRecordButtonTween();

          setTimeout(startVidRecording, 250);

      });

      //Get camera sources
      MediaStreamTrack.getSources(listcamSources);
      camSelector.onchange = resetCamera;

      function listcamSources(sourceInfos) {

        for (var i = 0; i != sourceInfos.length; ++i) {
          var sourceInfo = sourceInfos[i];
          var option = document.createElement("option");
          option.value = sourceInfo.id;

          if (sourceInfo.kind === 'video') {

            option.text = sourceInfo.label || 'camera ' + (camSelector.length + 1);
            camSelector.appendChild(option);

          }

        }

        //Preselect last option
        // camSelector.options[camSelector.length-1].selected = true;

      }

      function resetCamera() {
        if (cameraStream) {
          cameraStream.stop();
          cameraStream = null;
        }
      }


      function startVidRecording() {

        if (!cameraStream) {

          var cameraSource = camSelector.value;
          var videoConstraints = {
                                  audio: false,
                                  video: {
                                    mandatory: { },
                                    optional: [{sourceId: cameraSource}]
                                  }
                                };

          openCameraStream(videoConstraints);

        } else {

          startTimedRecording();

        }

        //Update buttons
        recordVideo.disabled = true;

      }

      function openCameraStream(videoConstraints) {

        navigator.getUserMedia(videoConstraints, function(stream) {

          //Success callback...
          video.src = URL.createObjectURL(stream);

          video.onloadedmetadata = function() {

            cameraStream = stream;
            video.width = captureWidth;
            video.height = captureHeight;
            recorder = window.RecordRTC(stream, captureOptions);
            startTimedRecording();

          };

        }, function() {

          //Error callback...
          alert('Camera access denied.');

        });

      }

      function startTimedRecording() {

        countdownCount = captureLength;
        countdown.innerHTML = ''+countdownCount;
        recorder.startRecording();

        countdownTimer = setInterval( function() {

          countdownCount--;
          countdown.innerHTML = ''+countdownCount;
          if (countdownCount == 0) {
            clearInterval(countdownTimer);
            stopVidRecording();
          }

        }, 1000);

      }

      function stopVidRecording() {
        if (recorder){

            recorder.stopRecording(function(url) {

                currentRecordingURL = url;
                closeRecordButtonTween();
                askForName();

            });

        }

        //Update buttons
        recordVideo.disabled = false;

      };

      function clearVisitorAfterDelay(blobURL, seconds) {

        setTimeout(function(){

          //Remove video from Blob memory
          URL.revokeObjectURL(blobURL);

          //Remove visitor from queue
          visitorQueue.shift();

          //If any visitorQueue waiting in queue, send it out.
          if (visitorQueue.length > 0){
            sendVisitor(visitorQueue[0].nameString, visitorQueue[0].videoURL);
          }

        }, seconds * 1000);

      };

      function currentPlaybackDelay() {
        var delay = delayPerVisitor * visitorQueue.length;

        if(visitorQueue.length == 1){
          delay += delayIfFirst;
        }

        return delay;
      }

      /* -- */
      /* UI */
      /* -- */

      function startRecordButtonTween() {

        $( "#count" ).html(''+captureLength);
        TweenMax.set( $( "#count" ), { css: { scale:0.4, opacity:0  } } );
        TweenMax.to( $( "#count" ), 0.4, { css: { opacity:1, scale:1 }, delay:0.25, ease:Power2.easeOut});
        TweenMax.set( $( "#record-video" ), { css: { scale:1  } } );
        TweenMax.to( $( "#record-video" ), 0.5, { css: { scale:0.8 }, delay:0.0, ease:Power2.easeOut});

        $('#circle').circleProgress({
          value: 1,
          animation: {  duration: (captureLength*1000)+500,
                        easing: "linear"
                      },
          startAngle: -Math.PI/2,
          size: 220,
          thickness: 40,
          reverse: false,
          fill: {
              gradient: ["#B41418 ", "#B41418"]
          },
          emptyFill: "rgba(240, 240, 240, .3)"
        });

        TweenMax.set( $( "#circle" ), { css: { scale:0.5 } } );
        TweenMax.to( $( "#circle" ), 0.5, { css: { scale:1 }, delay:0.2, ease:Power2.easeOut});

      }

      function closeRecordButtonTween() {

        TweenMax.to( $( "#count" ), 0.4, { css: { opacity:0 }, delay:0.0, ease:Power2.easeOut});
        TweenMax.to( $( "#record-video" ), 0.5, { css: { scale:1 }, delay:0.1, ease:Power2.easeOut});
        TweenMax.to( $( "#circle" ), 0.5, { css: { scale:0.5 }, delay:0.0, ease:Power2.easeIn});

      }

      function askForName() {

        //Reset fields
        $("#nameinput").val('');

        //Show popup
        $( "#enter-name" ).show();
        TweenMax.set( $( "#enter-name" ), { css: { scale:0.7, opacity:0  } } );
        TweenMax.to( $( "#enter-name" ), 0.5, { css: { scale:1, opacity:1 }, ease:Power2.easeIn, onComplete:function(){
          $("#nameinput").focus();
        }});

      }

      $("#btn_submitname").click( function(){
        nameSubmitted();
      });
      $("#nameinput").keyup(function (e) {
        if (e.keyCode == 13) { //capture return key
          nameSubmitted();
        }
      });

      function nameSubmitted(){
        var nameEntered = $("#nameinput").val();

        //Push into visitor queue
        visitorQueue.push({nameString:nameEntered, videoURL:currentRecordingURL});
        if (visitorQueue.length==1){
          sendVisitor(visitorQueue[0].nameString, visitorQueue[0].videoURL);
        }

        //Hide name popup
        TweenMax.to( $( "#enter-name" ), 0.3, { css: { scale:0.7, opacity:0 }, ease:Power2.easeIn, onComplete:function(){
          //Reset fields
          $("#nameinput").val('');
        }});

      }

      function getReadyCountdown(countstart) {

        console.log("Get Ready! Your video will play in "+countstart+" seconds! #BIGASTRONAUT");

        // $('#get_ready').show();
        // $('#get_ready #countdown').html(''+data.startDelay);

        // getReadyTimer = setInterval( function() {

        //   getReadyCount--;
        //   $('#get_ready #countdown').html(''+getReadyCount);
        //   if (getReadyCount == 0) {
        //     clearInterval(getReadyTimer);
        //   }

        // }, 1000);

      }

    </script>


  </body>
</html>