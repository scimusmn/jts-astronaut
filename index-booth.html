<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <title>Video Booth</title>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="../css/main.css">
    <link rel="stylesheet" href="../css/fonts/Aller/stylesheet.css">
    <!-- JS -->
    <script src="../js/vendor/jquery/dist/jquery.min.js"></script>
    <script src="../js/vendor/recordrtc/RecordRTC.js"></script>
    <script src="../js/vendor/jquery-circle-progress/dist/circle-progress.js"></script>
    <script src="../js/vendor/gsap/src/minified/TweenMax.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

  </head>
  <body>
    <div id="intake_screen" class="screen">

      <video id="intake_video" class="mirrored" autoplay="" loop="" muted=""></video>

      <div id="feed-overlay" class="overlay centered">

        <img id="facemask" src="../img/face-mask.png" class="centered"/>
        <img id="face" src="../img/face-outline.png" class="centered"/>

        <div id="record-video" class="button">
          <h1 id="count" class="centered"></h1>
          <div id="circle" class="centered"></div>
          <img id="redbtn" src="../img/record-red.png" class="centered"/>
        </div>

      </div>

      <div id="enter-name" class="popup" >
        <div class="popup-content front">
          <br/><br/>
          <div>

            <input id="nameinput" size="16" type="text" placeholder="NAME / NOMBRE" maxlength="15">
            <br/>
            <div id="btn_submitname" class="button"><h2>Next / Siguiente</h2></div>
          </div>
        </div>
        <div class="popup-content back">
          <br/>
          <h1>Prepare for launch.</h1>
          <h1 class="es">Prepárate para el lanzamiento.</h1>
          <h2>Have your camera ready.</h3>
          <h2 class="es">Ten tu cámara lista.</h3>
        </div>
      </div>

    </div>

    <div class="dev-panel" style="display:none">
      <label for='camSource_booth'>Booth video source: </label><select id='camSource_booth'></select>
      <br/><br/>
      <label for='resolume'>Resolume: </label>
      <button id="raise">Raise Visor</button>
      <button id="lower">Lower Visor</button>
      <br>
      <button id="fade-out">Fade Out</button>
      <button id="fade-in">Fade In</button>
      <br>
      <button id="toggle-visor">Show Visor</button>
      <button id="toggle-booth">Show Booth</button>
      <button id="toggle-loop">Show Loop</button>
    </div>

    <script type="text/javascript">

      /* Set up Socket.IO */
      var urlSplit = document.URL.split('/');
      var address = '//'+urlSplit[2]; // Same address that served this file. e.g. '//123.456.78:8080'
      var socket = io.connect(address);

      //Incoming...
      socket.on('handshake', function(data) {
          socket.emit('handshake-response', {clientId: 'booth'});
      });

      socket.on('video-file-ready', function(fileName) {
          onVideoFileReady(fileName);
      });

      socket.on('error', function() { console.error(arguments) });
      socket.on('message', function() { console.log(arguments) });

      //Outgoing...
      function exportVisitor() {

        console.log('exportVisitor');
        socket.emit('play-visitor', {nameString: visitorQueue[0].nameString, videoURL: visitorQueue[0].videoURL, captureLength:captureLength, playbackRate:playbackRate });

      }

      function deleteVideoFile(fileName){
        socket.emit('delete-video-file', {fileName:fileName});
      }

      function resolumeControl(controlStr){
        socket.emit('resolume-control', {control: controlStr});
      }


      /* ------------ */
      /* Record Video */
      /* ------------ */

      var recordVideo = $('#record-video')[0];
      var countdown = $('#count')[0];
      var video = $('#intake_video')[0];
      var camSelector = $('#camSource_booth')[0];

      var cameraStream;
      var recorder;
      var countdownCount;
      var countdownTimer;
      var recordLockout = false;
      var visorTransition = 2; //Time visor requires to raise or lower
      var minWaitTime = 13; // Time guaranteed to visitor prepare after submission.
      var playbackRate = 1;
      var captureLength = 15;
      var reloadTimeoutDelay = 60*2.5;
      var reloadTimeout = {};
      var captureWidth = 640;
      var captureHeight = 480;
      var captureOptions = {
                                type: 'video',
                                video: video,
                                canvas: {
                                    width: captureWidth,
                                    height: captureHeight
                                }
                            };

      var visitorQueue = [];
      var recordedVideoPath = '';
      var recordedFileName = '';
      var nameIsSubmitted = false;
      var nameEntryTimeout = {};
      var getReadyTimer = {};
      var getReadyCount = 0;

      $("#record-video").click( onRecordClicked );
      $("#btn_submitname").click( function(){
        nameSubmitted();
      });
      $("#nameinput").keyup(function (e) {
        if (e.keyCode == 13) { //capture return key
          nameSubmitted();
        }
      });
      $(".dev-panel button").click( function(){
          resolumeControl( $(this).attr('id') );
      });

      //Get camera sources
      MediaStreamTrack.getSources(listcamSources);
      camSelector.onchange = resetCamera;

      function listcamSources(sourceInfos) {

        for (var i = 0; i != sourceInfos.length; ++i) {
          var sourceInfo = sourceInfos[i];
          var option = document.createElement("option");
          option.value = sourceInfo.id;

          if (sourceInfo.kind === 'video') {

            option.text = sourceInfo.label || 'camera ' + (camSelector.length + 1);
            camSelector.appendChild(option);

          }

        }

      }

      function resetCamera() {
        if (cameraStream) {
          cameraStream.stop();
          cameraStream = null;
        }
      }

      function onRecordClicked(){
        resetReload();
        if (recordLockout==true) return;
        recordLockout = true;
        startRecordButtonTween();
        setTimeout(startVidRecording, 250);
      }

      initCamera();
      function initCamera(){
        startVidRecording();
        resetReload();
      }

      function startVidRecording() {

        if (!cameraStream) {

          var cameraSource = camSelector.value;
          var videoConstraints = {
                                  audio: false,
                                  video: {
                                    mandatory: { },
                                    optional: [{sourceId: cameraSource}]
                                  }
                                };

          openCameraStream(videoConstraints);

        } else {

          startTimedRecording();

        }

        //Update buttons
        recordVideo.disabled = true;

      }

      function openCameraStream(videoConstraints) {

        navigator.getUserMedia(videoConstraints, function(stream) {

          //Success callback...
          video.src = URL.createObjectURL(stream);

          video.onloadedmetadata = function() {

            cameraStream = stream;
            video.width = captureWidth;
            video.height = captureHeight;
            recorder = window.RecordRTC(stream, captureOptions);
            // startTimedRecording();

          };

        }, function() {

          //Error callback...
          // alert('Camera access denied.');
          console.log('Camera access denied.');

        });

      }

      function startTimedRecording() {

        countdownCount = captureLength;
        countdown.innerHTML = ''+countdownCount;
        recorder.startRecording();

        countdownTimer = setInterval( function() {

          countdownCount--;
          countdown.innerHTML = ''+countdownCount;
          if (countdownCount == 0) {
            clearInterval(countdownTimer);
            stopVidRecording();
          }

        }, 1000);

      }

      function stopVidRecording() {
        if (recorder){

            recorder.stopRecording(function(url) {

                recorder.getDataURL(function(videoDataURL) {

                    var data = {
                        video: {
                            type: recorder.getBlob().type || 'video/webm',
                            dataURL: videoDataURL
                        }
                    };

                    socket.emit('create-video-file', data);

                    //Wait to hear back from node that file was created...
                    //TODO: Show spinner until we hear back?

                });

            });

        }

        //Update buttons
        recordVideo.disabled = false;

      };

      function onVideoFileReady(fileName){

        console.log('onVideoFileReady', fileName);

        //base url
        var href = location.href.replace( location.href.split('/').pop(), '' );
        href = href.replace( href.split('/')[3], '' );
        href = href.slice(0, - 1);
        href = href + '/uploads/' + fileName;

        console.log('Video file path: ' + href);

        recordedVideoPath = href;
        recordedFileName = fileName;
        closeRecordButtonTween();
        askForName();

      }


      /* ------------- */
      /* --- QUEUE --- */
      /* ------------- */

      var delay_visor = visorTransition; //Should match duration of visor transition
      var delay_fade = 0.9; //Time to fade in/out comp
      var delay_playback = (captureLength/playbackRate) - (delay_fade*2);
      var delay_totalSequence = delay_visor+delay_playback+(delay_fade*4); //Total of visor open/close sequence
      var cur_source = 'visor';

      function newVisitor(nameEntered, recordedURL, recordedFilename){

        var now = new Date();
        visitorQueue.push({nameString:nameEntered, videoURL:recordedURL, fileName:recordedFilename, timestamp:now });

        if (visitorQueue.length == 1) {
          cueVisitorSequence(minWaitTime);
        }

        clearReload();

        //NOTE: This is not a highly accurate wait estimation, just using "Will be ready shortly" for now.
        // var wait = Math.ceil(minWaitTime + (delay_totalSequence*(visitorQueue.length-1)));
        // getReadyCountdown(wait);

      }

      function cueVisitorSequence(delay_begin){

        console.log('cueVisitorSequence. delay_begin:', delay_begin);

        if (cur_source != 'visor') {
          vidSource('visor');
        }

        setTimeout(function(){
          resolumeControl('raise');
          setTimeout(function() {
            vidSource('booth');
            setTimeout(function() {
              exportVisitor();
              setTimeout(function() {
                vidSource('visor');
                setTimeout(function() {
                  resolumeControl('lower');
                  setTimeout(function() {
                    visitorSequenceFinished();
                  }, delay_visor*1000);
                }, delay_fade*1000);
              }, delay_playback*1000);
            }, delay_fade*1000);
          }, delay_visor*1000);
        }, delay_begin*1000);

      }

      function vidSource(src) {
        cur_source = src;
        resolumeControl('fade-out');
        setTimeout(function(){
          resolumeControl('toggle-'+src);
          resolumeControl('fade-in');
        }, delay_fade*1000);
      }

      function visitorSequenceFinished() {

        deleteVideoFile(visitorQueue[0].fileName);
        URL.revokeObjectURL(visitorQueue[0].videoURL);
        visitorQueue.shift();

        console.log('visitorSequenceFinished. queue length:',visitorQueue.length);

        if (visitorQueue.length > 0){

          //Add delay if visitor has not had time to get ready.
          var untilMinWaitTime = minWaitTime - secDiff(visitorQueue[0].timestamp, new Date());
          cueVisitorSequence( Math.max(0, untilMinWaitTime) );

        } else {

          //No one in queue, keep visor down until timeout occurs.
          resetReload();

        }

      };

      function resetReload() {

        clearReload();

        reloadTimeout = setTimeout(function() {

          if (cur_source == 'visor' && visitorQueue.length == 0){

            //Raise visor with looping video
            resolumeControl('lower');
            resolumeControl('toggle-loop');

            //CHANGE NOTE: We are showing screensaver, then forcing refreshing the page.
            location.reload();

          } else {
            clearReload();
          }

        }, reloadTimeoutDelay*1000)

      }

      function clearReload() {

        if(reloadTimeout) clearTimeout(reloadTimeout);

        if (cur_source == 'loop'){
          vidSource('visor');
          resolumeControl('lower');
        }

      }

      function secDiff(date1, date2){
        var seconds = (date2.getTime() - date1.getTime())/1000;
        return seconds;
      }


      /* ---------- */
      /* --- UI --- */
      /* ---------- */

      initUI();

      function initUI(){

        TweenLite.set($("#enter-name").parent(), {perspective:1100});
        TweenLite.set($("#enter-name .popup-content"), {transformStyle:"preserve-3d"});
        TweenLite.set($(".back"), {rotationY:-180, rotationZ:180});
        TweenLite.set([$(".back"), $(".front")], {backfaceVisibility:"hidden"});

        $("#enter-name").hide();

        $('img').attr('draggable', false);

        TweenMax.set( $( "#facemask" ), { css: { opacity:0  } } );

      }

      function startRecordButtonTween() {

        $( "#count" ).html(''+captureLength);
        TweenMax.set( $( "#count" ), { css: { scale:0.4, opacity:0  } } );
        TweenMax.set( $( "#record-video" ), { css: { scale:1  } } );
        TweenMax.to( $( "#record-video" ), 0.5, { css: { scale:0.8 }, delay:0.0, ease:Power2.easeOut});
        TweenMax.to( $( "#facemask" ), 1, { css: { opacity:0.8 }, delay:0.5, ease:Power2.easeOut});

        $('#circle').circleProgress({
          value: 1,
          animation: {  duration: (captureLength*1000)+500,
                        easing: "linear"
                      },
          startAngle: -Math.PI/2,
          size: 220,
          thickness: 40,
          reverse: false,
          fill: {
              gradient: ["#B41418 ", "#B41418"]
          },
          emptyFill: "rgba(240, 240, 240, .3)"
        });

        TweenMax.set( $( "#circle" ), { css: { scale:0.5 } } );
        TweenMax.to( $( "#circle" ), 0.5, { css: { scale:1 }, delay:0.2, ease:Power2.easeOut});

      }

      function closeRecordButtonTween() {

        TweenMax.to( $( "#count" ), 0.4, { css: { opacity:0 }, delay:0.0, ease:Power2.easeOut});
        TweenMax.to( $( "#record-video" ), 0.5, { css: { scale:1 }, delay:0.1, ease:Power2.easeOut});
        TweenMax.to( $( "#circle" ), 0.5, { css: { scale:0.5 }, delay:0.0, ease:Power2.easeIn});

      }

      function askForName() {

        //Show popup
        $( "#nameinput" ).val('');
        $( "#enter-name" ).show();
        $( "#intake_video" ).addClass('effect-blur');
        TweenMax.to( $( "#facemask" ), 1, { css: { opacity:0 }, ease:Power2.easeOut});
        TweenMax.set( $( "#enter-name" ), { css: { opacity:0  } } );
        TweenMax.set( $( "#enter-name .popup-content" ), { css: { scale:0.7, opacity:0  } } );
        TweenMax.to( [$( "#enter-name" ), $( "#enter-name .popup-content" )], 0.5, { css: { scale:1, opacity:1 }, ease:Power2.easeIn, onComplete:function(){
          $("#nameinput").focus();
        }});

        nameIsSubmitted = false;

        //Timeout if no name submitted within 30 seconds
        nameEntryTimeout = setTimeout(function() {
          nameSubmitted();
        }, 30000)

      }

      function nameSubmitted(){

        clearInterval(nameEntryTimeout);
        if (nameIsSubmitted == true) return;
        nameIsSubmitted = true;

        //Push into visitor queue
        var nameEntered = $("#nameinput").val();
        newVisitor(nameEntered, recordedVideoPath, recordedFileName);

        //Flip Popup
        TweenLite.set($( "#getready-count" ), {opacity:0});
        TweenLite.to($( "#enter-name .popup-content" ), 0.8, {delay:0.1, rotationX:-180, ease:Power2.easeOut});
        setTimeout(returnToCameraView, 5000);

      }

      function getReadyCountdown(countstart) {

        getReadyCount = countstart;
        TweenMax.to( $( "#getready-count" ), 0.5, { css: { opacity:1 }, delay:1, ease:Power2.easeIn});

        $("#getready-count").html(''+getReadyCount);
        getReadyTimer = setInterval( function() {

          getReadyCount--;
          $("#getready-count").html(''+getReadyCount);

        }, 1000);

        setTimeout(function() {
          TweenMax.to( $( "#getready-count" ), 4.5, { css: { opacity:0 }, ease:Power2.easeIn});
        }, 4000);

      }

      function returnToCameraView(){

        //Hide name popup
        TweenMax.to( $( "#enter-name" ), 0.5, { css: { opacity:0 }, delay:0.2, ease:Power2.easeIn});
        TweenMax.to( $( "#enter-name .popup-content" ), 0.7, { css: { scale:0.7, opacity:0 }, ease:Power2.easeIn, onComplete:function(){
          //Reset fields
          $("#nameinput").val('');
          $( "#enter-name" ).hide();
          //Reset flipped state
          TweenLite.set($( "#enter-name .popup-content" ), {rotationX:0});
          //Clear get ready timer
          clearInterval(getReadyTimer);

        }});
        $( "#intake_video" ).removeClass('effect-blur');

        recordLockout = false;

      }



    </script>


  </body>
</html>
